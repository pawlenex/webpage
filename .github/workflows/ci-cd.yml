# ============================================================
# PawLenx â€” CI/CD Pipeline
# Workflow: On push to main â†’ create feature branch â†’ build 
# Docker image â†’ create PR â†’ merge on approval
# ============================================================

name: PawLenx CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths-ignore:
      - '*.md'
      - 'LICENSE'

permissions:
  contents: write
  pull-requests: write
  packages: write

env:
  IMAGE_NAME: pawlenx-web
  REGISTRY: ghcr.io

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Build & Test with Docker
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-test:
    name: ðŸ³ Build & Test Docker Image
    runs-on: ubuntu-latest

    outputs:
      branch_name: ${{ steps.create-branch.outputs.branch_name }}
      short_sha: ${{ steps.vars.outputs.short_sha }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Set build variables
        id: vars
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          BRANCH_NAME="deploy/${TIMESTAMP}-${SHORT_SHA}"
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      - name: ðŸ—ï¸ Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸ Build Docker image (for testing)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ§ª Test container starts and responds
        run: |
          echo "Starting container..."
          docker run -d --name test-pawlenx -p 8080:80 ${{ env.IMAGE_NAME }}:latest

          echo "Waiting for container to be healthy..."
          sleep 5

          echo "Testing healthcheck endpoint..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/healthz)
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Healthcheck passed (HTTP $HTTP_STATUS)"
          else
            echo "âŒ Healthcheck failed (HTTP $HTTP_STATUS)"
            docker logs test-pawlenx
            exit 1
          fi

          echo "Testing main page..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/)
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Main page loads (HTTP $HTTP_STATUS)"
          else
            echo "âŒ Main page failed (HTTP $HTTP_STATUS)"
            docker logs test-pawlenx
            exit 1
          fi

          echo "Verifying page content..."
          CONTENT=$(curl -s http://localhost:8080/)
          if echo "$CONTENT" | grep -q "PawLenx"; then
            echo "âœ… Page content verified â€” 'PawLenx' found"
          else
            echo "âŒ Page content missing â€” 'PawLenx' not found"
            exit 1
          fi

          echo "Checking static assets..."
          CSS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/css/styles.css)
          JS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/js/main.js)
          echo "CSS: HTTP $CSS_STATUS | JS: HTTP $JS_STATUS"

          if [ "$CSS_STATUS" -eq 200 ] && [ "$JS_STATUS" -eq 200 ]; then
            echo "âœ… All static assets accessible"
          else
            echo "âŒ Static assets check failed"
            exit 1
          fi

          docker stop test-pawlenx
          docker rm test-pawlenx
          echo "ðŸŽ‰ All tests passed!"

      - name: ðŸ“¦ Push multi-platform Docker image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Create deployment branch & PR
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-pr:
    name: ðŸ”€ Create Deployment PR
    runs-on: ubuntu-latest
    needs: build-and-test

    outputs:
      pr_number: ${{ steps.open-pr.outputs.pr_number }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Set build variables
        id: vars
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          BRANCH_NAME="deploy/${TIMESTAMP}-${SHORT_SHA}"
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      - name: ðŸŒ¿ Create deployment branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="${{ steps.vars.outputs.branch_name }}"
          echo "Creating branch: ${BRANCH_NAME}"

          git checkout -b "${BRANCH_NAME}"

          # Add a deployment manifest to track the build
          cat > DEPLOYMENT.md << EOF
          # Deployment Info

          - **Commit:** ${{ github.sha }}
          - **Short SHA:** ${{ steps.vars.outputs.short_sha }}
          - **Branch:** ${BRANCH_NAME}
          - **Triggered by:** ${{ github.actor }}
          - **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - **Docker Image:** ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
          - **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF

          git add DEPLOYMENT.md
          git commit -m "deploy: build ${{ steps.vars.outputs.short_sha }} â€” $(date +'%Y-%m-%d %H:%M')"
          git push origin "${BRANCH_NAME}"

      - name: ðŸ“‹ Create Pull Request
        id: open-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head "${{ steps.vars.outputs.branch_name }}" \
            --title "ðŸš€ Deploy: Build ${{ steps.vars.outputs.short_sha }}" \
            --body "## ðŸ¾ PawLenx Deployment

          ### Build Summary
          | Detail | Value |
          |--------|-------|
          | **Commit** | \`${{ github.sha }}\` |
          | **Author** | @${{ github.actor }} |
          | **Docker Image** | \`${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}\` |
          | **Workflow** | [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

          ### âœ… Checks Passed
          - [x] Docker image builds successfully
          - [x] Container healthcheck passes
          - [x] Main page loads (HTTP 200)
          - [x] Page content verified (\"PawLenx\" found)
          - [x] Static assets (CSS/JS) accessible
          - [x] Docker image pushed to GHCR

          ### ðŸ³ Run Locally
          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
          docker run -p 8080:80 ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
          \`\`\`

          ---
          > **Approve and merge** this PR to complete the deployment." \
            --label "deployment")

          echo "âœ… PR created: ${PR_URL}"
          PR_NUMBER=$(echo "$PR_URL" | grep -o '[0-9]*$')
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Auto-merge the deployment PR
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  auto-merge:
    name: ðŸ”€ Auto-Merge Deployment PR
    runs-on: ubuntu-latest
    needs: create-pr
    if: success() && needs.create-pr.outputs.pr_number != ''

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”„ Merge the deployment PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ needs.create-pr.outputs.pr_number }}"
          echo "Merging PR #${PR_NUMBER}..."
          gh pr merge "${PR_NUMBER}" --squash --auto
          echo "âœ… Auto-merge enabled for PR #${PR_NUMBER}"
